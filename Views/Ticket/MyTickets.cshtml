@model IEnumerable<Ticket>
@{
    ViewData["Title"] = "My Tickets";
}

<!DOCTYPE html>
<html class="dark" lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>My Tickets - Enterprise IT Support Suite</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
<script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#1392ec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101a22",
                        "card-dark": "#1e293b",
                        "status-open": "#3b82f6",
                        "status-progress": "#f59e0b",
                        "status-resolved": "#10b981",
                    },
                    fontFamily: {
                        "display": ["Manrope"]
                    },
                    borderRadius: {"DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px"},
                },
            },
        }
    </script>
<style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        body {
            font-family: 'Manrope', sans-serif;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 10px;
        }
        .truncate-2-lines {
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-slate-100 min-h-screen">
<div class="min-h-screen flex flex-col">
    <!-- Header only - no sidebar -->
    <header class="h-16 border-b border-slate-200 dark:border-slate-800 px-8 flex items-center justify-between bg-white dark:bg-[#101a22] z-10">
        <div class="flex items-center gap-6">
            <a href="@Url.Action("Dashboard", "Home")" class="px-4 py-2 text-sm font-medium text-slate-600 dark:text-slate-300 hover:text-primary transition-colors">
                <span class="material-symbols-outlined text-[18px] mr-1">arrow_back</span>
                Back to Dashboard
            </a>
            <h2 class="text-lg font-bold tracking-tight">My Ticket History</h2>
            <div class="h-6 w-px bg-slate-200 dark:bg-slate-800"></div>
            <div class="flex items-center gap-2 text-xs font-semibold text-slate-500">
                <span>Support</span>
                <span class="material-symbols-outlined text-[14px]">chevron_right</span>
                <span class="text-primary">My Tickets</span>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <button class="px-4 py-2 bg-primary text-white text-xs font-bold rounded-lg hover:bg-primary/90 transition-all flex items-center gap-2" onclick="location.href='@Url.Action("Create", "Ticket")'">
                <span class="material-symbols-outlined text-[18px]">add</span>
                New Ticket
            </button>
            <div class="h-6 w-px bg-slate-200 dark:bg-slate-800 mx-2"></div>
            <button class="relative size-10 flex items-center justify-center bg-slate-100 dark:bg-slate-800 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
                <span class="material-symbols-outlined text-slate-600 dark:text-slate-300">notifications</span>
                <span class="absolute top-2.5 right-2.5 size-2 bg-red-500 rounded-full border-2 border-white dark:border-[#101a22]"></span>
            </button>
        </div>
    </header>
<div class="flex-1 overflow-y-auto p-8 custom-scrollbar">
<div class="max-w-[1400px] mx-auto space-y-6">
<div class="flex flex-col md:flex-row gap-4 items-center justify-between">
<form method="get" action="@Url.Action("MyTickets", "Ticket")" class="flex flex-col md:flex-row gap-4 items-center w-full" id="searchForm">
<div class="relative w-full md:w-96">
<span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-[20px]" id="searchIcon">search</span>
<input name="search" value="@ViewBag.Search" id="searchInput" class="w-full bg-white dark:bg-[#1e293b] border-slate-200 dark:border-slate-800 rounded-lg pl-10 pr-10 py-2 text-sm focus:ring-primary focus:border-primary transition-all" placeholder="Search by Ticket ID, title..." type="text"/>
<div id="searchSpinner" class="absolute right-3 top-1/2 -translate-y-1/2 hidden">
    <div class="animate-spin rounded-full h-4 w-4 border-2 border-slate-300 border-t-primary"></div>
</div>
@if (!string.IsNullOrEmpty(ViewBag.Search))
{
    <button type="button" onclick="clearSearch()" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 transition-colors" id="clearButton">
        <span class="material-symbols-outlined text-[18px]">close</span>
    </button>
}
</div>
<div class="flex items-center gap-2 w-full md:w-auto">
<select name="status" class="bg-white dark:bg-[#1e293b] border-slate-200 dark:border-slate-800 rounded-lg px-4 py-2 text-xs font-semibold focus:ring-primary focus:border-primary transition-all" id="statusSelect">
<option value="All" selected="@(ViewBag.Status == "All")">All Status</option>
<option value="Open" selected="@(ViewBag.Status == "Open")">Open</option>
<option value="In-Progress" selected="@(ViewBag.Status == "In-Progress")">In-Progress</option>
<option value="Resolved" selected="@(ViewBag.Status == "Resolved")">Resolved</option>
<option value="Closed" selected="@(ViewBag.Status == "Closed")">Closed</option>
</select>
<select name="category" class="bg-white dark:bg-[#1e293b] border-slate-200 dark:border-slate-800 rounded-lg px-4 py-2 text-xs font-semibold focus:ring-primary focus:border-primary transition-all" id="categorySelect">
<option value="All" selected="@(ViewBag.Category == "All")">All Problem Types</option>
<option value="Software Issue" selected="@(ViewBag.Category == "Software Issue")">Software</option>
<option value="Hardware Failure" selected="@(ViewBag.Category == "Hardware Failure")">Hardware</option>
<option value="Network/Access Issue" selected="@(ViewBag.Category == "Network/Access Issue")">Access</option>
<option value="Email & Communication" selected="@(ViewBag.Category == "Email & Communication")">Network</option>
</select>
<button type="submit" class="p-2 bg-white dark:bg-[#1e293b] border border-slate-200 dark:border-slate-800 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
<span class="material-symbols-outlined text-[20px] text-slate-500">filter_list</span>
</button>
<button type="button" onclick="clearAllFilters()" class="px-3 py-2 bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors flex items-center gap-2">
<span class="material-symbols-outlined text-[18px] text-slate-600 dark:text-slate-400">refresh</span>
<span class="text-xs font-semibold text-slate-600 dark:text-slate-400">Clear</span>
</button>
</div>
</form>
</div>
<div class="bg-white dark:bg-[#1e293b] rounded-xl border border-slate-200 dark:border-slate-800 shadow-xl overflow-hidden relative">
<div id="tableLoadingOverlay" class="absolute inset-0 bg-white/80 dark:bg-[#1e293b]/80 backdrop-blur-sm z-10 hidden">
    <div class="flex items-center justify-center h-32">
        <div class="flex flex-col items-center gap-3">
            <div class="animate-spin rounded-full h-8 w-8 border-2 border-slate-300 border-t-primary"></div>
            <span class="text-sm text-slate-600 dark:text-slate-400">Searching...</span>
        </div>
    </div>
</div>
<div class="overflow-x-auto" id="ticketTableContainer">
<table class="w-full text-left border-collapse">
<thead>
<tr class="bg-slate-50/50 dark:bg-slate-900/40 border-b border-slate-100 dark:border-slate-800">
<th class="px-6 py-4 text-[11px] font-bold text-slate-500 uppercase tracking-wider w-32">Ticket ID</th>
<th class="px-6 py-4 text-[11px] font-bold text-slate-500 uppercase tracking-wider w-40">Problem Type</th>
<th class="px-6 py-4 text-[11px] font-bold text-slate-500 uppercase tracking-wider">Description</th>
<th class="px-6 py-4 text-[11px] font-bold text-slate-500 uppercase tracking-wider w-32">Location</th>
<th class="px-6 py-4 text-[11px] font-bold text-slate-500 uppercase tracking-wider w-40">Status</th>
<th class="px-6 py-4 text-[11px] font-bold text-slate-500 uppercase tracking-wider w-44">Date Submitted</th>
<th class="px-6 py-4 text-[11px] font-bold text-slate-500 uppercase tracking-wider w-24">Actions</th>
</tr>
</thead>
<tbody class="divide-y divide-slate-100 dark:divide-slate-800">
@if (Model != null && Model.Any())
{
    @foreach (var ticket in Model)
    {
        <tr class="group hover:bg-slate-50/50 dark:hover:bg-slate-900/20 transition-colors">
            <td class="px-6 py-4">
                <span class="text-sm font-bold text-primary">#TIC-@ticket.Id.ToString("D4")</span>
            </td>
            <td class="px-6 py-4">
                <div class="flex items-center gap-2">
                    <span class="material-symbols-outlined text-[18px] text-slate-400">
                        @(ticket.Category.ToLower() switch {
                            "software issue" => "system_update",
                            "hardware failure" => "devices",
                            "network/access issue" => "wifi",
                            "email & communication" => "mail",
                            "asset request" => "inventory",
                            _ => "help"
                        })
                    </span>
                    <span class="text-sm font-medium">@ticket.Category</span>
                </div>
            </td>
            <td class="px-6 py-4">
                <div class="max-w-md">
                    <p class="text-sm text-slate-600 dark:text-slate-300 truncate-2-lines">@ticket.Description</p>
                </div>
            </td>
            <td class="px-6 py-4">
                <div class="flex items-center gap-2 text-slate-500" title="Work Location">
                    <span class="material-symbols-outlined text-[18px]">
                        @(ticket.WorkLocation?.Contains("Work From Home") == true || ticket.WorkLocation?.Contains("WFH") == true ? "home_work" : "apartment")
                    </span>
                    <span class="text-xs">@(ticket.WorkLocation?.Contains("Work From Home") == true || ticket.WorkLocation?.Contains("WFH") == true ? "WFH" : "Office")</span>
                </div>
            </td>
            <td class="px-6 py-4">
                <span class="inline-flex items-center px-2.5 py-1 rounded-full text-[10px] font-bold @(ticket.Status.ToLower() switch {
                    "open" => "bg-blue-100 dark:bg-blue-500/10 text-blue-600 dark:text-blue-400 border border-blue-200 dark:border-blue-500/20",
                    "in-progress" => "bg-amber-100 dark:bg-amber-500/10 text-amber-600 dark:text-amber-400 border border-amber-200 dark:border-amber-500/20",
                    "resolved" => "bg-emerald-100 dark:bg-emerald-500/10 text-emerald-600 dark:text-emerald-400 border border-emerald-200 dark:border-emerald-500/20",
                    "closed" => "bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 border border-slate-200 dark:border-slate-700",
                    _ => "bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 border border-slate-200 dark:border-slate-700"
                }) uppercase tracking-wider">
                    @ticket.Status
                </span>
            </td>
            <td class="px-6 py-4">
                <div class="text-xs text-slate-500 group-hover:text-slate-300 transition-colors">
                    @DateTime.Now.ToString("MMM dd, yyyy • hh:mm tt")
                </div>
            </td>
            <td class="px-6 py-4">
                <div class="flex items-center gap-2">
                    <button class="p-1.5 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-800 text-slate-400 hover:text-primary transition-all relative group/btn" onclick="showTicketDetails(@ticket.Id, '@(ticket.TeamViewerId?.Replace("'", "\\'") ?? "")', '@(ticket.TeamViewerPassword?.Replace("'", "\\'") ?? "")', '@(ticket.ContactEmail?.Replace("'", "\\'") ?? "")', '@(ticket.ContactNumber?.Replace("'", "\\'") ?? "")', '@(ticket.Attachments?.Replace("'", "\\'") ?? "")')">
                        <span class="material-symbols-outlined text-[20px]">visibility</span>
                        <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 hidden group-hover/btn:block bg-slate-900 text-white text-[10px] py-1 px-2 rounded whitespace-nowrap z-20">
                            View Details
                        </div>
                    </button>
                    <button class="p-1.5 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-800 text-slate-400 hover:text-white transition-all" onclick="showEditTicketModal(@ticket.Id, '@(ticket.TeamViewerId?.Replace("'", "\\'") ?? "")', '@(ticket.TeamViewerPassword?.Replace("'", "\\'") ?? "")', '@(ticket.ContactEmail?.Replace("'", "\\'") ?? "")', '@(ticket.ContactNumber?.Replace("'", "\\'") ?? "")', '@(ticket.Attachments?.Replace("'", "\\'") ?? "")', '@ticket.Status', '@ticket.Priority', '@ticket.Department', '@ticket.Category')">
<span class="material-symbols-outlined text-[20px]">more_vert</span>
</button>
                </div>
            </td>
        </tr>
    }
}
else
{
    <tr>
        <td colspan="7" class="px-6 py-12 text-center">
            <div class="flex flex-col items-center gap-4">
                <span class="material-symbols-outlined text-4xl text-slate-300">inbox</span>
                <p class="text-sm text-slate-500">No tickets found. Create your first ticket to get started!</p>
                <button class="px-4 py-2 bg-primary text-white text-xs font-bold rounded-lg hover:bg-primary/90 transition-all flex items-center gap-2" onclick="location.href='@Url.Action("Create", "Ticket")'">
                    <span class="material-symbols-outlined text-[18px]">add</span>
                    Create Ticket
                </button>
            </div>
        </td>
    </tr>
}
</tbody>
</table>
</div>
<div class="p-4 border-t border-slate-100 dark:border-slate-800 bg-slate-50/30 dark:bg-slate-900/40 flex items-center justify-between">
<p class="text-xs text-slate-500 font-medium">
    Showing 
    <span class="text-slate-900 dark:text-white">
        @(((ViewBag.CurrentPage - 1) * ViewBag.PageSize) + 1)
    </span> 
    to 
    <span class="text-slate-900 dark:text-white">
        @Math.Min(ViewBag.CurrentPage * ViewBag.PageSize, ViewBag.TotalCount)
    </span> 
    of 
    <span class="text-slate-900 dark:text-white">@ViewBag.TotalCount</span> 
    tickets
</p>
<div class="flex items-center gap-1">
    @if (ViewBag.HasPreviousPage)
    {
        <a href="@Url.Action("MyTickets", new { page = ViewBag.CurrentPage - 1, search = ViewBag.Search, status = ViewBag.Status, category = ViewBag.Category })" 
           class="size-8 flex items-center justify-center rounded border border-slate-200 dark:border-slate-800 text-slate-500 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
            <span class="material-symbols-outlined text-[18px]">chevron_left</span>
        </a>
    }
    else
    {
        <button class="size-8 flex items-center justify-center rounded border border-slate-200 dark:border-slate-800 text-slate-500 hover:bg-slate-50 dark:hover:bg-slate-800 disabled:opacity-50 transition-colors" disabled>
            <span class="material-symbols-outlined text-[18px]">chevron_left</span>
        </button>
    }
    
    @for (int i = 1; i <= ViewBag.TotalPages; i++)
    {
        if (i == ViewBag.CurrentPage)
        {
            <button class="size-8 flex items-center justify-center rounded bg-primary text-white text-xs font-bold">@i</button>
        }
        else
        {
            <a href="@Url.Action("MyTickets", new { page = i, search = ViewBag.Search, status = ViewBag.Status, category = ViewBag.Category })" 
               class="size-8 flex items-center justify-center rounded border border-slate-200 dark:border-slate-800 text-slate-500 hover:bg-slate-50 dark:hover:bg-slate-800 text-xs font-bold transition-colors">
                @i
            </a>
        }
    }
    
    @if (ViewBag.HasNextPage)
    {
        <a href="@Url.Action("MyTickets", new { page = ViewBag.CurrentPage + 1, search = ViewBag.Search, status = ViewBag.Status, category = ViewBag.Category })" 
           class="size-8 flex items-center justify-center rounded border border-slate-200 dark:border-slate-800 text-slate-500 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
            <span class="material-symbols-outlined text-[18px]">chevron_right</span>
        </a>
    }
    else
    {
        <button class="size-8 flex items-center justify-center rounded border border-slate-200 dark:border-slate-800 text-slate-500 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors" disabled>
            <span class="material-symbols-outlined text-[18px]">chevron_right</span>
        </button>
    }
</div>
</div>
</div>
<p class="text-center text-xs text-slate-500">
                    Showing your ticket history from the last 90 days. For older tickets, please contact the <span class="text-primary font-bold">Archive Department</span>.
                </p>
</div>
</div>

<!-- Ticket Details Modal -->
<div id="ticketModal" class="fixed inset-0 z-[100] flex items-center justify-center p-4 hidden">
<div class="absolute inset-0 bg-slate-950/80 backdrop-blur-sm"></div>
<div class="relative w-full max-w-2xl bg-[#1e293b] rounded-2xl border border-slate-700 shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
<div class="p-6 border-b border-slate-700 flex items-center justify-between bg-slate-900/50">
<div class="flex items-center gap-4">
<div class="size-12 bg-primary/20 rounded-xl flex items-center justify-center text-primary">
<span class="material-symbols-outlined text-3xl">confirmation_number</span>
</div>
<div>
<div class="flex items-center gap-3">
<h3 id="modalTicketId" class="text-xl font-bold text-white tracking-tight">#TIC-0000</h3>
<span id="modalTicketStatus" class="inline-flex items-center px-2.5 py-1 rounded-full text-[10px] font-bold bg-blue-500/10 text-blue-400 border border-blue-500/20 uppercase tracking-wider">
Open
</span>
</div>
<p id="modalTicketMeta" class="text-xs text-slate-400 mt-1 font-medium">Problem Type • Submitted Date</p>
</div>
</div>
<button onclick="closeTicketModal()" class="size-10 rounded-full hover:bg-slate-800 flex items-center justify-center text-slate-400 hover:text-white transition-colors">
<span class="material-symbols-outlined">close</span>
</button>
</div>
<div class="flex-1 overflow-y-auto p-6 custom-scrollbar space-y-8">
<section>
<h4 class="text-[11px] font-bold text-slate-500 uppercase tracking-widest mb-4 flex items-center gap-2">
<span class="material-symbols-outlined text-[16px]">person</span>
User Information
</h4>
<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
<div class="bg-slate-900/40 p-3 rounded-lg border border-slate-800">
<p class="text-[10px] text-slate-500 uppercase font-bold mb-1">Email Address</p>
<p id="modalUserEmail" class="text-sm font-medium text-slate-200 break-words">user@company.com</p>
</div>
<div class="bg-slate-900/40 p-3 rounded-lg border border-slate-800">
<p class="text-[10px] text-slate-500 uppercase font-bold mb-1">Contact Number</p>
<p id="modalUserPhone" class="text-sm font-medium text-slate-200">+1 (555) 000-0000</p>
</div>
<div class="bg-slate-900/40 p-3 rounded-lg border border-slate-800">
<p class="text-[10px] text-slate-500 uppercase font-bold mb-1">Location</p>
<div class="flex items-center gap-1.5">
<span id="modalLocationIcon" class="material-symbols-outlined text-[16px] text-slate-400">apartment</span>
<p id="modalUserLocation" class="text-sm font-medium text-slate-200">Office</p>
</div>
</div>
</div>
</section>
<section>
<h4 class="text-[11px] font-bold text-slate-500 uppercase tracking-widest mb-4 flex items-center gap-2">
<span class="material-symbols-outlined text-[16px]">settings_remote</span>
Remote Access Details
</h4>
<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
<div class="flex items-center justify-between p-3 rounded-lg border border-slate-800 bg-slate-900/40">
<div>
<p class="text-[10px] text-slate-500 uppercase font-bold mb-1">Team Viewer ID</p>
<p id="modalTeamViewerId" class="text-sm font-mono text-primary font-bold tracking-wider">N/A</p>
</div>
<button class="text-slate-500 hover:text-primary transition-colors" onclick="copyToClipboard('modalTeamViewerId')">
<span class="material-symbols-outlined text-[20px]">content_copy</span>
</button>
</div>
<div class="flex items-center justify-between p-3 rounded-lg border border-slate-800 bg-slate-900/40">
<div>
<p class="text-[10px] text-slate-500 uppercase font-bold mb-1">Password</p>
<div class="flex items-center gap-2">
<p id="modalTeamViewerPassword" class="text-sm font-mono text-slate-200 font-bold tracking-widest">••••••••</p>
</div>
</div>
<button class="text-slate-500 hover:text-primary transition-colors" onclick="togglePasswordVisibility()">
<span id="passwordToggleIcon" class="material-symbols-outlined text-[20px]">visibility</span>
</button>
</div>
</div>
</section>
<section>
<h4 class="text-[11px] font-bold text-slate-500 uppercase tracking-widest mb-4 flex items-center gap-2">
<span class="material-symbols-outlined text-[16px]">description</span>
Problem Description
</h4>
<div class="bg-slate-900/40 p-5 rounded-lg border border-slate-800">
<h5 id="modalTicketSubject" class="text-sm font-bold text-white mb-2">Ticket Subject</h5>
</div>
</section>
<section>
<h4 class="text-[11px] font-bold text-slate-500 uppercase tracking-widest mb-4 flex items-center gap-2">
<span class="material-symbols-outlined text-[16px]">attach_file</span>
Attachments
</h4>
<div class="bg-slate-900/40 p-5 rounded-lg border border-slate-800">
<div id="modalAttachments" class="space-y-3">
<p class="text-sm text-slate-400">No attachments uploaded</p>
</div>
</div>
</section>
</div>
<div class="p-6 border-t border-slate-700 bg-slate-900/50 flex items-center justify-between">
<button onclick="closeTicketModal()" class="px-5 py-2.5 text-xs font-bold text-slate-400 hover:text-white transition-colors flex items-center gap-2 border border-slate-700 rounded-lg hover:bg-slate-800">
<span class="material-symbols-outlined text-[18px]">close</span>
Close
</button>
<div class="flex items-center gap-3">
<button class="px-5 py-2.5 text-xs font-bold text-slate-300 bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-lg transition-all flex items-center gap-2">
<span class="material-symbols-outlined text-[18px]">add_comment</span>
Add Comment
</button>
<button onclick="openEditFromView()" class="px-5 py-2.5 text-xs font-bold text-white bg-primary hover:bg-primary/90 rounded-lg transition-all flex items-center gap-2 shadow-lg shadow-primary/20">
<span class="material-symbols-outlined text-[18px]">edit_note</span>
Update Ticket
</button>
</div>
</div>
</div>
</div>

<!-- Edit Ticket Modal -->
<div id="editTicketModal" class="fixed inset-0 z-[100] flex items-center justify-center p-4 hidden">
<div class="absolute inset-0 bg-slate-950/80 backdrop-blur-sm"></div>
<div class="relative w-full max-w-3xl bg-[#1e293b] rounded-2xl border border-slate-700 shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
<div class="p-6 border-b border-slate-700 flex items-center justify-between bg-slate-900/50">
<div class="flex items-center gap-4">
<div class="size-12 bg-primary/20 rounded-xl flex items-center justify-center text-primary">
<span class="material-symbols-outlined text-3xl">edit_note</span>
</div>
<div>
<div class="flex items-center gap-3">
<h3 id="editModalTicketId" class="text-xl font-bold text-white tracking-tight">#TIC-0000</h3>
<span id="editModalTicketStatus" class="inline-flex items-center px-2.5 py-1 rounded-full text-[10px] font-bold bg-blue-500/10 text-blue-400 border border-blue-500/20 uppercase tracking-wider">
Open
</span>
</div>
<p id="editModalTicketMeta" class="text-xs text-slate-400">Software Issue • Feb 1, 2026, 04:55 PM</p>
</div>
</div>
<button onclick="closeEditTicketModal()" class="p-2 rounded-lg hover:bg-slate-800 text-slate-400 hover:text-white transition-colors">
<span class="material-symbols-outlined text-xl">close</span>
</button>
</div>
<div class="flex-1 overflow-y-auto p-6 custom-scrollbar space-y-6">
<form id="editTicketForm" onsubmit="updateTicket(event)">
<input type="hidden" id="editTicketIdInput" name="ticketId" />
<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
<div class="space-y-2">
<label class="text-sm font-bold text-slate-300">Status</label>
<select id="editStatus" name="status" class="w-full bg-slate-800 border-slate-700 rounded-lg px-4 py-2.5 text-sm text-slate-500 cursor-not-allowed" disabled>
<option value="Open">Open</option>
<option value="In-Progress">In-Progress</option>
<option value="Resolved">Resolved</option>
<option value="Closed">Closed</option>
</select>
</div>
<div class="space-y-2">
<label class="text-sm font-bold text-slate-300">Priority</label>
<select id="editPriority" name="priority" class="w-full bg-slate-900 border-slate-700 rounded-lg px-4 py-2.5 text-sm focus:ring-primary focus:border-primary">
<option value="Low">Low</option>
<option value="Medium">Medium</option>
<option value="High">High</option>
<option value="Critical">Critical</option>
</select>
</div>
</div>
<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
<div class="space-y-2">
<label class="text-sm font-bold text-slate-300">Department</label>
<input type="text" id="editDepartment" name="department" class="w-full bg-slate-900 border-slate-700 rounded-lg px-4 py-2.5 text-sm focus:ring-primary focus:border-primary" placeholder="e.g., Finance / HR / IT" />
</div>
<div class="space-y-2">
<label class="text-sm font-bold text-slate-300">Category</label>
<select id="editCategory" name="category" class="w-full bg-slate-900 border-slate-700 rounded-lg px-4 py-2.5 text-sm focus:ring-primary focus:border-primary">
<option value="Software Issue">Software Issue</option>
<option value="Hardware Issue">Hardware Issue</option>
<option value="Network Issue">Network Issue</option>
<option value="Access Issue">Access Issue</option>
</select>
</div>
</div>
<div class="space-y-2">
<label class="text-sm font-bold text-slate-300">Subject</label>
<input type="text" id="editSubject" name="subject" class="w-full bg-slate-900 border-slate-700 rounded-lg px-4 py-2.5 text-sm focus:ring-primary focus:border-primary" placeholder="Enter ticket subject" />
</div>
<div class="space-y-2">
<label class="text-sm font-bold text-slate-300">Description</label>
<textarea id="editDescription" name="description" rows="4" class="w-full bg-slate-900 border-slate-700 rounded-lg px-4 py-2.5 text-sm focus:ring-primary focus:border-primary" placeholder="Describe the issue in detail"></textarea>
</div>
<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
<div class="space-y-2">
<label class="text-sm font-bold text-slate-300">Team Viewer ID</label>
<input type="text" id="editTeamViewerId" name="teamViewerId" class="w-full bg-slate-900 border-slate-700 rounded-lg px-4 py-2.5 text-sm focus:ring-primary focus:border-primary" placeholder="Enter TeamViewer ID" />
</div>
<div class="space-y-2">
<label class="text-sm font-bold text-slate-300">Team Viewer Password</label>
<input type="password" id="editTeamViewerPassword" name="teamViewerPassword" class="w-full bg-slate-900 border-slate-700 rounded-lg px-4 py-2.5 text-sm focus:ring-primary focus:border-primary" placeholder="Enter TeamViewer Password" />
</div>
</div>
<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
<div class="space-y-2">
<label class="text-sm font-bold text-slate-300">Contact Email</label>
<input type="email" id="editContactEmail" name="contactEmail" class="w-full bg-slate-900 border-slate-700 rounded-lg px-4 py-2.5 text-sm focus:ring-primary focus:border-primary" placeholder="user@company.com" />
</div>
<div class="space-y-2">
<label class="text-sm font-bold text-slate-300">Contact Number</label>
<input type="tel" id="editContactNumber" name="contactNumber" class="w-full bg-slate-900 border-slate-700 rounded-lg px-4 py-2.5 text-sm focus:ring-primary focus:border-primary" placeholder="+1 (555) 000-0000" />
</div>
</div>
</form>
</div>
<div class="p-6 border-t border-slate-700 bg-slate-900/50 flex items-center justify-between">
<button onclick="closeEditTicketModal()" class="px-5 py-2.5 text-xs font-bold text-slate-400 hover:text-white transition-colors flex items-center gap-2 border border-slate-700 rounded-lg hover:bg-slate-800">
<span class="material-symbols-outlined text-[18px]">close</span>
Cancel
</button>
<div class="flex items-center gap-3">
<button type="submit" form="editTicketForm" class="px-5 py-2.5 text-xs font-bold text-white bg-primary hover:bg-primary/90 rounded-lg transition-all flex items-center gap-2 shadow-lg shadow-primary/20">
<span class="material-symbols-outlined text-[18px]">save</span>
Update Ticket
</button>
</div>
</div>
</div>
</div>

<!-- Success Toast Notification -->
@if (TempData["SuccessMessage"] != null)
{
    <div id="successToast" class="fixed top-4 right-4 bg-green-500 text-white px-6 py-4 rounded-lg shadow-lg flex items-center gap-3 z-50 transform transition-transform duration-300 translate-x-full">
        <span class="material-symbols-outlined text-white">check_circle</span>
        <span class="font-medium">@TempData["SuccessMessage"]</span>
    </div>
}

<script>
    // Show success toast if it exists
    document.addEventListener('DOMContentLoaded', function() {
        const toast = document.getElementById('successToast');
        if (toast) {
            // Slide in the toast
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
                toast.classList.add('translate-x-0');
            }, 100);
            
            // Hide the toast after 5 seconds
            setTimeout(() => {
                toast.classList.remove('translate-x-0');
                toast.classList.add('translate-x-full');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 5000);
        }
        
        // Enhanced smooth search functionality
        const searchInput = document.getElementById('searchInput');
        const searchSpinner = document.getElementById('searchSpinner');
        const searchIcon = document.getElementById('searchIcon');
        const clearButton = document.getElementById('clearButton');
        const tableOverlay = document.getElementById('tableLoadingOverlay');
        const statusSelect = document.getElementById('statusSelect');
        const categorySelect = document.getElementById('categorySelect');
        let searchTimeout;
        
        function showLoading() {
            searchSpinner.classList.remove('hidden');
            searchIcon.classList.add('hidden');
            if (clearButton) clearButton.classList.add('hidden');
            tableOverlay.classList.remove('hidden');
        }
        
        function hideLoading() {
            searchSpinner.classList.add('hidden');
            searchIcon.classList.remove('hidden');
            tableOverlay.classList.add('hidden');
        }
        
        function performSearch() {
            const form = document.getElementById('searchForm');
            if (form) {
                showLoading();
                // Add a small delay to show loading state
                setTimeout(() => {
                    form.submit();
                }, 300);
            }
        }
        
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                const hasValue = this.value.trim().length > 0;
                
                // Show/hide clear button dynamically
                if (clearButton) {
                    clearButton.style.display = hasValue ? 'block' : 'none';
                }
                
                // Debounced search with shorter delay for better UX
                searchTimeout = setTimeout(() => {
                    performSearch();
                }, 300); // Reduced from 500ms to 300ms for faster response
            });
            
            // Add keyup event for immediate feedback on Enter
            searchInput.addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    clearTimeout(searchTimeout);
                    performSearch();
                }
            });
        }
        
        // Add change listeners for dropdowns with smooth transitions
        if (statusSelect) {
            statusSelect.addEventListener('change', function() {
                showLoading();
                setTimeout(() => {
                    document.getElementById('searchForm').submit();
                }, 200);
            });
        }
        
        if (categorySelect) {
            categorySelect.addEventListener('change', function() {
                showLoading();
                setTimeout(() => {
                    document.getElementById('searchForm').submit();
                }, 200);
            });
        }
    });
    
    // Modal functions
    function showTicketDetails(ticketId, teamViewerId, teamViewerPassword, contactEmail, contactNumber, attachments) {
        // Find the ticket data from the table row
        const ticketRow = document.querySelector(`button[onclick*="showTicketDetails(${ticketId}"]`).closest('tr');
        const cells = ticketRow.getElementsByTagName('td');
        
        // Extract ticket data from the table
        const ticketIdText = cells[0].textContent.trim();
        const category = cells[1].textContent.trim();
        const description = cells[2].textContent.trim();
        const location = cells[3].textContent.trim();
        const status = cells[4].textContent.trim();
        const date = cells[5].textContent.trim();
        
        // Update modal content
        const now = new Date();
        const timestamp = now.getFullYear().toString() + (now.getMonth() + 1).toString().padStart(2, '0') + now.getDate().toString().padStart(2, '0') + now.getHours().toString().padStart(2, '0') + now.getMinutes().toString().padStart(2, '0');
        document.getElementById('modalTicketId').textContent = `#TIC-${timestamp}`;
        document.getElementById('modalTicketStatus').textContent = status;
        
        // Format current time for display
        const currentTime = now.toLocaleString('en-US', { 
            month: 'short', 
            day: 'numeric', 
            year: 'numeric', 
            hour: '2-digit', 
            minute: '2-digit' 
        });
        document.getElementById('modalTicketMeta').textContent = `${category} • ${currentTime}`;
        
        // Extract subject from description (first sentence or first 50 chars)
        const subjectText = description.split('.')[0].trim() || description.substring(0, 50).trim();
        document.getElementById('modalTicketSubject').textContent = subjectText;
        
        // Update status styling
        const statusElement = document.getElementById('modalTicketStatus');
        statusElement.className = 'inline-flex items-center px-2.5 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider border';
        
        if (status.includes('Open')) {
            statusElement.className += ' bg-blue-500/10 text-blue-400 border-blue-500/20';
        } else if (status.includes('In-Progress')) {
            statusElement.className += ' bg-amber-500/10 text-amber-400 border-amber-500/20';
        } else if (status.includes('Resolved')) {
            statusElement.className += ' bg-emerald-500/10 text-emerald-400 border-emerald-500/20';
        } else if (status.includes('Closed')) {
            statusElement.className += ' bg-slate-500/10 text-slate-400 border-slate-500/20';
        }
        
        // Update location
        const locationIcon = document.getElementById('modalLocationIcon');
        const locationText = document.getElementById('modalUserLocation');
        if (location.includes('WFH')) {
            locationIcon.textContent = 'home_work';
            locationText.textContent = 'Work From Home';
        } else {
            locationIcon.textContent = 'apartment';
            locationText.textContent = 'Office';
        }
        
        // Update user information with actual data
        document.getElementById('modalUserEmail').textContent = contactEmail || 'user@company.com';
        document.getElementById('modalUserPhone').textContent = contactNumber || '+1 (555) 000-0000';
        
        // Update TeamViewer details with actual data
        document.getElementById('modalTeamViewerId').textContent = teamViewerId || 'N/A';
        document.getElementById('modalTeamViewerPassword').textContent = teamViewerPassword ? '••••••••' : '••••••••';
        
        // Store actual password for toggle functionality
        if (teamViewerPassword) {
            document.getElementById('modalTeamViewerPassword').setAttribute('data-password', teamViewerPassword);
        }
        
        // Update attachments
        const attachmentsContainer = document.getElementById('modalAttachments');
        if (attachments && attachments.trim() !== '') {
            const attachmentFiles = attachments.split(';').filter(file => file.trim() !== '');
            if (attachmentFiles.length > 0) {
                let attachmentsHtml = '';
                attachmentFiles.forEach((fileName, index) => {
                    const fileIcon = getFileIcon(fileName);
                    attachmentsHtml += `
                        <div class="flex items-center justify-between p-3 bg-slate-800/50 rounded-lg border border-slate-700 hover:bg-slate-800 transition-colors">
                            <div class="flex items-center gap-3">
                                <span class="material-symbols-outlined text-[20px] text-slate-400">${fileIcon}</span>
                                <div>
                                    <p class="text-sm font-medium text-slate-200">${fileName}</p>
                                    <p class="text-xs text-slate-500">Attachment ${index + 1}</p>
                                </div>
                            </div>
                            <button onclick="viewAttachment('${fileName}')" class="p-2 rounded-lg hover:bg-slate-700 text-slate-400 hover:text-primary transition-colors" title="View attachment">
                                <span class="material-symbols-outlined text-[20px]">visibility</span>
                            </button>
                        </div>
                    `;
                });
                attachmentsContainer.innerHTML = attachmentsHtml;
            } else {
                attachmentsContainer.innerHTML = '<p class="text-sm text-slate-400">No attachments uploaded</p>';
            }
        } else {
            attachmentsContainer.innerHTML = '<p class="text-sm text-slate-400">No attachments uploaded</p>';
        }
        
        // Show modal
        document.getElementById('ticketModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }
    
    function closeTicketModal() {
        document.getElementById('ticketModal').classList.add('hidden');
        document.body.style.overflow = 'auto';
    }
    
    function getFileIcon(fileName) {
        const extension = fileName.split('.').pop().toLowerCase();
        const iconMap = {
            'pdf': 'picture_as_pdf',
            'doc': 'description',
            'docx': 'description',
            'txt': 'text_snippet',
            'jpg': 'image',
            'jpeg': 'image',
            'png': 'image',
            'gif': 'image',
            'svg': 'image',
            'log': 'description',
            'zip': 'folder_zip',
            'rar': 'folder_zip',
            'xlsx': 'table_chart',
            'xls': 'table_chart',
            'pptx': 'slideshow',
            'ppt': 'slideshow'
        };
        return iconMap[extension] || 'attach_file';
    }
    
    function viewAttachment(fileName) {
        const extension = fileName.split('.').pop().toLowerCase();
        const imageExtensions = ['jpg', 'jpeg', 'png', 'gif', 'svg', 'webp'];
        const textExtensions = ['txt', 'log', 'md'];
        
        if (imageExtensions.includes(extension)) {
            // Show image in preview modal
            showImagePreview(fileName);
        } else if (textExtensions.includes(extension)) {
            // Show text content in preview modal
            showTextPreview(fileName);
        } else {
            // For other file types, show file info modal
            showFileInfo(fileName);
        }
    }
    
    function showImagePreview(fileName) {
        const imageUrl = `/Ticket/DownloadAttachment?fileName=${encodeURIComponent(fileName)}`;
        
        // Create or update preview modal
        let previewModal = document.getElementById('imagePreviewModal');
        if (!previewModal) {
            previewModal = document.createElement('div');
            previewModal.id = 'imagePreviewModal';
            previewModal.className = 'fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/80';
            previewModal.innerHTML = `
                <div class="relative max-w-4xl max-h-[90vh] bg-white rounded-lg overflow-hidden">
                    <div class="flex items-center justify-between p-4 border-b">
                        <h3 class="text-lg font-semibold text-gray-900">${fileName}</h3>
                        <button onclick="closeImagePreview()" class="text-gray-500 hover:text-gray-700">
                            <span class="material-symbols-outlined text-2xl">close</span>
                        </button>
                    </div>
                    <div class="p-4 overflow-auto max-h-[70vh]">
                        <img src="${imageUrl}" alt="${fileName}" class="max-w-full h-auto mx-auto" />
                    </div>
                    <div class="p-4 border-t flex justify-end gap-3">
                        <button onclick="closeImagePreview()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">
                            Close
                        </button>
                        <a href="${imageUrl}" download="${fileName}" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90">
                            Download
                        </a>
                    </div>
                </div>
            `;
            document.body.appendChild(previewModal);
        } else {
            // Update existing modal
            previewModal.querySelector('h3').textContent = fileName;
            previewModal.querySelector('img').src = imageUrl;
            previewModal.querySelector('img').alt = fileName;
            previewModal.querySelector('a').href = imageUrl;
            previewModal.querySelector('a').download = fileName;
        }
        
        previewModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }
    
    function closeImagePreview() {
        const previewModal = document.getElementById('imagePreviewModal');
        if (previewModal) {
            previewModal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
    }
    
    function showTextPreview(fileName) {
        const textUrl = `/Ticket/DownloadAttachment?fileName=${encodeURIComponent(fileName)}`;
        
        // Fetch text content and display
        fetch(textUrl)
            .then(response => response.text())
            .then(content => {
                showTextContentModal(fileName, content);
            })
            .catch(error => {
                console.error('Error loading text file:', error);
                showFileInfo(fileName);
            });
    }
    
    function showTextContentModal(fileName, content) {
        let textModal = document.getElementById('textPreviewModal');
        if (!textModal) {
            textModal = document.createElement('div');
            textModal.id = 'textPreviewModal';
            textModal.className = 'fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/80';
            textModal.innerHTML = `
                <div class="relative max-w-4xl max-h-[90vh] bg-white rounded-lg overflow-hidden">
                    <div class="flex items-center justify-between p-4 border-b">
                        <h3 class="text-lg font-semibold text-gray-900">${fileName}</h3>
                        <button onclick="closeTextPreview()" class="text-gray-500 hover:text-gray-700">
                            <span class="material-symbols-outlined text-2xl">close</span>
                        </button>
                    </div>
                    <div class="p-4 overflow-auto max-h-[70vh]">
                        <pre class="text-sm text-gray-800 whitespace-pre-wrap bg-gray-50 p-4 rounded border">${content}</pre>
                    </div>
                    <div class="p-4 border-t flex justify-end gap-3">
                        <button onclick="closeTextPreview()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">
                            Close
                        </button>
                        <a href="/Ticket/DownloadAttachment?fileName=${encodeURIComponent(fileName)}" download="${fileName}" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90">
                            Download
                        </a>
                    </div>
                </div>
            `;
            document.body.appendChild(textModal);
        } else {
            // Update existing modal
            textModal.querySelector('h3').textContent = fileName;
            textModal.querySelector('pre').textContent = content;
            textModal.querySelector('a').href = `/Ticket/DownloadAttachment?fileName=${encodeURIComponent(fileName)}`;
            textModal.querySelector('a').download = fileName;
        }
        
        textModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }
    
    function closeTextPreview() {
        const textModal = document.getElementById('textPreviewModal');
        if (textModal) {
            textModal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
    }
    
    function showFileInfo(fileName) {
        // For non-previewable files, show file info
        const extension = fileName.split('.').pop().toLowerCase();
        const fileSize = "Unknown"; // You could implement file size detection
        
        const infoModal = document.createElement('div');
        infoModal.className = 'fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/80';
        infoModal.innerHTML = `
            <div class="relative max-w-md bg-white rounded-lg overflow-hidden">
                <div class="flex items-center justify-between p-4 border-b">
                    <h3 class="text-lg font-semibold text-gray-900">File Information</h3>
                    <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                        <span class="material-symbols-outlined text-2xl">close</span>
                    </button>
                </div>
                <div class="p-4">
                    <div class="space-y-3">
                        <div>
                            <label class="text-sm font-medium text-gray-500">File Name:</label>
                            <p class="text-sm text-gray-900">${fileName}</p>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-500">File Type:</label>
                            <p class="text-sm text-gray-900">${extension.toUpperCase()}</p>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-500">Size:</label>
                            <p class="text-sm text-gray-900">${fileSize}</p>
                        </div>
                    </div>
                </div>
                <div class="p-4 border-t flex justify-end">
                    <a href="/Ticket/DownloadAttachment?fileName=${encodeURIComponent(fileName)}" download="${fileName}" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90">
                        Download File
                    </a>
                </div>
            </div>
        `;
        document.body.appendChild(infoModal);
        document.body.style.overflow = 'hidden';
    }
    
    // Edit Ticket Modal Functions
    function showEditTicketModal(ticketId, teamViewerId, teamViewerPassword, contactEmail, contactNumber, attachments, status, priority, department, category) {
        // Find the ticket data from the table row
        const ticketRow = document.querySelector(`button[onclick*="showEditTicketModal(${ticketId}"]`).closest('tr');
        const cells = ticketRow.getElementsByTagName('td');
        
        // Extract ticket data from the table
        const ticketIdText = cells[0].textContent.trim();
        const categoryText = cells[1].textContent.trim();
        const description = cells[2].textContent.trim();
        const location = cells[3].textContent.trim();
        const statusText = cells[4].textContent.trim();
        const date = cells[5].textContent.trim();
        
        // Update modal header
        const now = new Date();
        const timestamp = now.getFullYear().toString() + (now.getMonth() + 1).toString().padStart(2, '0') + now.getDate().toString().padStart(2, '0') + now.getHours().toString().padStart(2, '0') + now.getMinutes().toString().padStart(2, '0');
        document.getElementById('editModalTicketId').textContent = `#TIC-${timestamp}`;
        document.getElementById('editModalTicketStatus').textContent = statusText;
        
        // Format current time for display
        const currentTime = now.toLocaleString('en-US', { 
            month: 'short', 
            day: 'numeric', 
            year: 'numeric', 
            hour: '2-digit', 
            minute: '2-digit' 
        });
        document.getElementById('editModalTicketMeta').textContent = `${categoryText} • ${currentTime}`;
        
        // Update status styling
        const statusElement = document.getElementById('editModalTicketStatus');
        statusElement.className = 'inline-flex items-center px-2.5 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider border';
        
        if (statusText.includes('Open')) {
            statusElement.className += ' bg-blue-500/10 text-blue-400 border-blue-500/20';
        } else if (statusText.includes('In-Progress')) {
            statusElement.className += ' bg-amber-500/10 text-amber-400 border-amber-500/20';
        } else if (statusText.includes('Resolved')) {
            statusElement.className += ' bg-emerald-500/10 text-emerald-400 border-emerald-500/20';
        } else if (statusText.includes('Closed')) {
            statusElement.className += ' bg-slate-500/10 text-slate-400 border-slate-500/20';
        }
        
        // Populate form fields with current data
        document.getElementById('editTicketIdInput').value = ticketId;
        document.getElementById('editStatus').value = status || 'Open';
        document.getElementById('editPriority').value = priority || 'Medium';
        document.getElementById('editDepartment').value = department || 'IT Support';
        document.getElementById('editCategory').value = category || 'Software Issue';
        document.getElementById('editSubject').value = description.split('.')[0].trim() || '';
        document.getElementById('editDescription').value = description || '';
        document.getElementById('editTeamViewerId').value = teamViewerId || '';
        document.getElementById('editTeamViewerPassword').value = teamViewerPassword || '';
        document.getElementById('editContactEmail').value = contactEmail || '';
        document.getElementById('editContactNumber').value = contactNumber || '';
        
        // Show modal
        document.getElementById('editTicketModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }
    
    function closeEditTicketModal() {
        document.getElementById('editTicketModal').classList.add('hidden');
        document.body.style.overflow = 'auto';
    }
    
    function openEditFromView() {
        // Get current ticket data from the view modal
        const ticketId = document.getElementById('modalTicketId').textContent.replace('#TIC-', '');
        const status = document.getElementById('modalTicketStatus').textContent;
        const meta = document.getElementById('modalTicketMeta').textContent;
        const category = meta.split(' • ')[0];
        const subject = document.getElementById('modalTicketSubject').textContent;
        const description = document.getElementById('modalTicketDescription').textContent;
        const email = document.getElementById('modalUserEmail').textContent;
        const phone = document.getElementById('modalUserPhone').textContent;
        const teamViewerId = document.getElementById('modalTeamViewerId').textContent;
        const teamViewerPassword = document.getElementById('modalTeamViewerPassword').getAttribute('data-password') || '';
        
        // Close view modal
        closeTicketModal();
        
        // Open edit modal with current data
        setTimeout(() => {
            showEditTicketModal(ticketId, teamViewerId, teamViewerPassword, email, phone, '', status, 'Medium', '', category);
        }, 300);
    }
    
    function updateTicket(event) {
        event.preventDefault();
        
        const formData = new FormData(document.getElementById('editTicketForm'));
        
        // Show loading state
        const submitButton = document.querySelector('button[type="submit"]');
        const originalText = submitButton.innerHTML;
        submitButton.innerHTML = '<span class="material-symbols-outlined animate-spin">refresh</span> Updating...';
        submitButton.disabled = true;
        
        // Close modal immediately
        closeEditTicketModal();
        
        // Send update request
        fetch('/Ticket/UpdateTicket', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message
                showSuccessToast('Ticket updated successfully!');
                
                // Refresh the page to show updated data
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                showSuccessToast('Error updating ticket: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showSuccessToast('Error updating ticket. Please try again.');
        })
        .finally(() => {
            // Restore button state
            submitButton.innerHTML = originalText;
            submitButton.disabled = false;
        });
    }
    
    function showSuccessToast(message) {
        const toast = document.createElement('div');
        toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-4 rounded-lg shadow-lg flex items-center gap-3 z-50 transform transition-transform duration-300 translate-x-full';
        toast.innerHTML = `
            <span class="material-symbols-outlined text-white">check_circle</span>
            <span class="font-medium">${message}</span>
        `;
        document.body.appendChild(toast);
        
        // Animate in
        setTimeout(() => {
            toast.classList.remove('translate-x-full');
        }, 100);
        
        // Remove after 3 seconds
        setTimeout(() => {
            toast.classList.add('translate-x-full');
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 300);
        }, 3000);
    }
    
    // Search functionality for tickets table
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.querySelector('input[placeholder="Search tickets..."]');
        const tableRows = document.querySelectorAll('tbody tr');
        
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                
                tableRows.forEach(row => {
                    if (row.cells.length > 1) { // Skip "No tickets found" row
                        const ticketId = row.cells[0].textContent.toLowerCase();
                        const category = row.cells[1].textContent.toLowerCase();
                        const description = row.cells[2].textContent.toLowerCase();
                        const location = row.cells[3].textContent.toLowerCase();
                        const status = row.cells[4].textContent.toLowerCase();
                        const date = row.cells[5].textContent.toLowerCase();
                        
                        const rowText = ticketId + ' ' + category + ' ' + description + ' ' + location + ' ' + status + ' ' + date;
                        
                        if (rowText.includes(searchTerm)) {
                            row.style.display = '';
                        } else {
                            row.style.display = 'none';
                        }
                    }
                });
                
                // Update ticket count display
                const visibleRows = Array.from(tableRows).filter(row => 
                    row.style.display !== 'none' && row.cells.length > 1
                );
                const countText = document.querySelector('h3.text-slate-900.dark\\:text-white');
                if (countText) {
                    const totalTickets = visibleRows.length;
                    countText.textContent = `All Tickets (${totalTickets})`;
                }
            });
        }
    });
    
    function copyToClipboard(elementId) {
        const text = document.getElementById(elementId).textContent;
        if (text && text !== 'N/A') {
            navigator.clipboard.writeText(text).then(() => {
                // Show brief feedback
                const button = event.target.closest('button');
                const originalHTML = button.innerHTML;
                button.innerHTML = '<span class="material-symbols-outlined text-[20px] text-green-400">check</span>';
                setTimeout(() => {
                    button.innerHTML = originalHTML;
                }, 1000);
            });
        }
    }
    
    function togglePasswordVisibility() {
        const passwordElement = document.getElementById('modalTeamViewerPassword');
        const toggleIcon = document.getElementById('passwordToggleIcon');
        
        if (passwordElement.textContent.includes('•')) {
            // Show actual password
            const actualPassword = passwordElement.getAttribute('data-password');
            if (actualPassword) {
                passwordElement.textContent = actualPassword;
                toggleIcon.textContent = 'visibility_off';
            }
        } else {
            // Hide password
            passwordElement.textContent = '••••••••';
            toggleIcon.textContent = 'visibility';
        }
    }
    
    function clearAllFilters() {
        const searchInput = document.getElementById('searchInput');
        const statusSelect = document.getElementById('statusSelect');
        const categorySelect = document.getElementById('categorySelect');
        const tableOverlay = document.getElementById('tableLoadingOverlay');
        
        // Show loading state
        tableOverlay.classList.remove('hidden');
        
        // Reset all filter fields
        if (searchInput) {
            searchInput.value = '';
        }
        if (statusSelect) {
            statusSelect.value = 'All';
        }
        if (categorySelect) {
            categorySelect.value = 'All';
        }
        
        // Hide clear button
        const clearButton = document.getElementById('clearButton');
        if (clearButton) {
            clearButton.style.display = 'none';
        }
        
        // Redirect to clean page (refresh without query parameters)
        setTimeout(() => {
            window.location.href = '@Url.Action("MyTickets", "Ticket")';
        }, 200);
    }
    
    function clearSearch() {
        const searchInput = document.getElementById('searchInput');
        const clearButton = document.getElementById('clearButton');
        const tableOverlay = document.getElementById('tableLoadingOverlay');
        
        // Show loading state
        tableOverlay.classList.remove('hidden');
        
        if (searchInput) {
            searchInput.value = '';
        }
        
        // Hide clear button immediately
        if (clearButton) {
            clearButton.style.display = 'none';
        }
        
        // Submit form after brief delay
        setTimeout(() => {
            const form = document.querySelector('form');
            if (form) {
                form.submit();
            }
        }, 200);
    }
    
    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeTicketModal();
        }
    });
</script>
</body></html>
